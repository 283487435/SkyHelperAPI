module.exports = {
    skillNames: {
        experience_skill_enchanting: "skyblock_augmentation",
        experience_skill_taming: "skyblock_domesticator",
        experience_skill_alchemy: "skyblock_concoctor",
        experience_skill_mining: "skyblock_excavator",
        experience_skill_farming: "skyblock_harvester",
        experience_skill_foraging: "skyblock_gatherer",
        experience_skill_combat: "skyblock_combat",
        experience_skill_fishing: "skyblock_angler"
    },

    dungeonExperienceTable: [
        0,
        50,
        125,
        235,
        395,
        625,
        955,
        1425,
        2095,
        3045,
        4385,
        6275,
        8940,
        12700,
        17960,
        25340,
        35640,
        50040,
        70040,
        97640,
        135640,
        188140,
        259640,
        356640,
        488640,
        668640,
        911640,
        1239640,
        1684640,
        2284640,
        3084640,
        4149640,
        5559640,
        7459640,
        9959640,
        13259640,
        17559640,
        23159640,
        30359640,
        39559640,
        51559640,
        66559640,
        85559640,
        109559640,
        139559640,
        177559640,
        225559640,
        285559640,
        360559640,
        453559640,
        569809640,
        999999999999999999999999999999999999999999999999999999
    ],
    dungeonMaxXP: 569809640,
    dungeonOverall: 1.2733079672009226,
    dungeonCompletionWorth: [
        0.0827,
        2.1034,
        4.5966,
        7.9383,
        13.4018,
        23.1071,
        43.7857,
        63.3437,
        29.048912,
        38.548938,
        51.624065,
        67.004612,
        75.234512,
        99.20524,
        295.090592
    ],
    dungeonCompletionBuffs: {
        "1": 62.5,
        "2": 125,
        "3": 225,
        "4": 387.5,
        "5": 500,
        "6": 700,
        "7": 1500
    },
    skillXPPerLevel: [
        0,
        50,
        125,
        200,
        300,
        500,
        750,
        1000,
        1500,
        2000,
        3500,
        5000,
        7500,
        10000,
        15000,
        20000,
        30000,
        50000,
        75000,
        100000,
        200000,
        300000,
        400000,
        500000,
        600000,
        700000,
        800000,
        900000,
        1000000,
        1100000,
        1200000,
        1300000,
        1400000,
        1500000,
        1600000,
        1700000,
        1800000,
        1900000,
        2000000,
        2100000,
        2200000,
        2300000,
        2400000,
        2500000,
        2600000,
        2750000,
        2900000,
        3100000,
        3400000,
        3700000,
        4000000,
        4300000,
        4600000,
        4900000,
        5200000,
        5500000,
        5800000,
        6100000,
        6400000,
        6700000,
        7000000
    ],
    skillMaxXP: 111672425,
    skillOverflowMultipliers: [
        6.3207,
        9.2003,
        4.1641,
        77.2840,
        123.5962,
        163.0884,
        227.5907,
        504.2361
    ],
    skillFactors: [
        0.8970917856434051,
        0.9038421238097485,
        0.88836322872987277,
        0.929383683888072,
        0.9329795030275141,
        0.9348318885884501,
        0.9368106217543707,
        0.9401081007640278
    ],
    srw: {
        enchanting: [
            0,
            0.025,
            0.05,
            0.075,
            0.1,
            0.125,
            0.15,
            0.175,
            0.2,
            0.225,
            0.25,
            0.275,
            0.3,
            0.325,
            0.35,
            0.375,
            0.4,
            0.425,
            0.45,
            0.475,
            0.5,
            0.525,
            0.55,
            0.575,
            0.6,
            0.625,
            0.65,
            0.675,
            0.7,
            0.725,
            0.75,
            0.775,
            0.8,
            0.825,
            0.85,
            0.875,
            0.9,
            0.925,
            0.95,
            0.975,
            1.0,
            1.025,
            1.05,
            1.075,
            1.1,
            1.125,
            1.15,
            1.175,
            1.2,
            1.225,
            1.25,
            1.28125,
            1.3125,
            1.34375,
            1.375,
            1.40625,
            1.4375,
            1.46875,
            1.5,
            1.53125,
            1.5625,
            40
        ],
        taming: [
            0,
            0.025,
            0.05,
            0.075,
            0.1,
            0.125,
            0.15,
            0.175,
            0.2,
            0.225,
            0.25,
            0.275,
            0.3,
            0.325,
            0.35,
            0.375,
            0.4,
            0.425,
            0.45,
            0.475,
            0.5,
            0.525,
            0.55,
            0.575,
            0.6,
            0.625,
            0.65,
            0.675,
            0.7,
            0.725,
            0.75,
            0.775,
            0.8,
            0.825,
            0.85,
            0.875,
            0.9,
            0.925,
            0.95,
            0.975,
            1.0,
            1.025,
            1.05,
            1.075,
            1.1,
            1.125,
            1.15,
            1.175,
            1.2,
            1.225,
            1.25,
            1.28125,
            1.3125,
            1.34375,
            1.375,
            1.40625,
            1.4375,
            1.46875,
            1.5,
            1.53125,
            1.5625,
            45
        ],
        alchemy: [
            0,
            0.025,
            0.05,
            0.075,
            0.1,
            0.125,
            0.15,
            0.175,
            0.2,
            0.225,
            0.25,
            0.275,
            0.3,
            0.325,
            0.35,
            0.375,
            0.4,
            0.425,
            0.45,
            0.475,
            0.5,
            0.525,
            0.55,
            0.575,
            0.6,
            0.625,
            0.65,
            0.675,
            0.7,
            0.725,
            0.75,
            0.775,
            0.8,
            0.825,
            0.85,
            0.875,
            0.9,
            0.925,
            0.95,
            0.975,
            1.0,
            1.025,
            1.05,
            1.075,
            1.1,
            1.125,
            1.15,
            1.175,
            1.2,
            1.225,
            1.25,
            1.28125,
            1.3125,
            1.34375,
            1.375,
            1.40625,
            1.4375,
            1.46875,
            1.5,
            1.53125,
            1.5625,
            50
        ],
        mining: [
            0,
            0.025,
            0.05,
            0.075,
            0.1,
            0.125,
            0.15,
            0.175,
            0.2,
            0.225,
            0.25,
            0.275,
            0.3,
            0.325,
            0.35,
            0.375,
            0.4,
            0.425,
            0.45,
            0.475,
            0.5,
            0.525,
            0.55,
            0.575,
            0.6,
            0.625,
            0.65,
            0.675,
            0.7,
            0.725,
            0.75,
            0.775,
            0.8,
            0.825,
            0.85,
            0.875,
            0.9,
            0.925,
            0.95,
            0.975,
            1.0,
            1.025,
            1.05,
            1.075,
            1.1,
            1.125,
            1.15,
            1.175,
            1.2,
            1.225,
            1.25,
            1.28125,
            1.3125,
            1.34375,
            1.375,
            1.40625,
            1.4375,
            1.46875,
            1.5,
            1.53125,
            1.5625,
            80
        ],
        farming: [
            0,
            0.025,
            0.05,
            0.075,
            0.1,
            0.125,
            0.15,
            0.175,
            0.2,
            0.225,
            0.25,
            0.275,
            0.3,
            0.325,
            0.35,
            0.375,
            0.4,
            0.425,
            0.45,
            0.475,
            0.5,
            0.525,
            0.55,
            0.575,
            0.6,
            0.625,
            0.65,
            0.675,
            0.7,
            0.725,
            0.75,
            0.775,
            0.8,
            0.825,
            0.85,
            0.875,
            0.9,
            0.925,
            0.95,
            0.975,
            1.0,
            1.025,
            1.05,
            1.075,
            1.1,
            1.125,
            1.15,
            1.175,
            1.2,
            1.225,
            1.25,
            1.28125,
            1.3125,
            1.34375,
            1.375,
            1.40625,
            1.4375,
            1.46875,
            1.5,
            1.53125,
            1.5625,
            85
        ],
        foraging: [
            0,
            0.025,
            0.05,
            0.075,
            0.1,
            0.125,
            0.15,
            0.175,
            0.2,
            0.225,
            0.25,
            0.275,
            0.3,
            0.325,
            0.35,
            0.375,
            0.4,
            0.425,
            0.45,
            0.475,
            0.5,
            0.525,
            0.55,
            0.575,
            0.6,
            0.625,
            0.65,
            0.675,
            0.7,
            0.725,
            0.75,
            0.775,
            0.8,
            0.825,
            0.85,
            0.875,
            0.9,
            0.925,
            0.95,
            0.975,
            1.0,
            1.025,
            1.05,
            1.075,
            1.1,
            1.125,
            1.15,
            1.175,
            1.2,
            1.225,
            1.25,
            1.28125,
            1.3125,
            1.34375,
            1.375,
            1.40625,
            1.4375,
            1.46875,
            1.5,
            1.53125,
            1.5625,
            95
        ],
        combat: [
            0,
            0.025,
            0.05,
            0.075,
            0.1,
            0.125,
            0.15,
            0.175,
            0.2,
            0.225,
            0.25,
            0.275,
            0.3,
            0.325,
            0.35,
            0.375,
            0.4,
            0.425,
            0.45,
            0.475,
            0.5,
            0.525,
            0.55,
            0.575,
            0.6,
            0.625,
            0.65,
            0.675,
            0.7,
            0.725,
            0.75,
            0.775,
            0.8,
            0.825,
            0.85,
            0.875,
            0.9,
            0.925,
            0.95,
            0.975,
            1.0,
            1.025,
            1.05,
            1.075,
            1.1,
            1.125,
            1.15,
            1.175,
            1.2,
            1.225,
            1.25,
            1.28125,
            1.3125,
            1.34375,
            1.375,
            1.40625,
            1.4375,
            1.46875,
            1.5,
            1.53125,
            1.5625,
            95
        ],
        fishing: [
            0,
            0.025,
            0.05,
            0.075,
            0.1,
            0.125,
            0.15,
            0.175,
            0.2,
            0.225,
            0.25,
            0.275,
            0.3,
            0.325,
            0.35,
            0.375,
            0.4,
            0.425,
            0.45,
            0.475,
            0.5,
            0.525,
            0.55,
            0.575,
            0.6,
            0.625,
            0.65,
            0.675,
            0.7,
            0.725,
            0.75,
            0.775,
            0.8,
            0.825,
            0.85,
            0.875,
            0.9,
            0.925,
            0.95,
            0.975,
            1.0,
            1.025,
            1.05,
            1.075,
            1.1,
            1.125,
            1.15,
            1.175,
            1.2,
            1.225,
            1.25,
            1.28125,
            1.3125,
            1.34375,
            1.375,
            1.40625,
            1.4375,
            1.46875,
            1.5,
            1.53125,
            1.5625,
            100
        ]
    },
    slayerDeprecationScaling: [
        0.75030106128,
        0.7732512436,
        0.80852054920,
        0.8374104242,
        0.87
    ],
    skillOverall: 1.8162162162162162

}

const { skillXPPerLevel, skillNames, slayerDeprecationScaling, dungeonCompletionWorth, dungeonCompletionBuffs, srw, skillMaxXP, skillOverflowMultipliers, skillFactors, skillOverall, dungeonExperienceTable, dungeonMaxXP, dungeonOverall } = require("../constants/lilyWeight");

const getSlayerScore = exp => {
    // thank you Lucy -Desco
    const d = exp / 100000;
    if (exp >= 6416) {
        const D = (d - Math.pow(3, (-5 / 2))) * (d + Math.pow(3, -5 / 2));
        const u = Math.cbrt(3 * (d + Math.sqrt(D)));
        const v = Math.cbrt(3 * (d - Math.sqrt(D)));
        return u + v - 1;
    } else {
        return Math.sqrt(4 / 3) * Math.cos(Math.acos(d * Math.pow(3, 5 / 2)) / 3) - 1;
    }
};

const getEffectiveXP = (score, ind) => {
    const scaling = slayerDeprecationScaling[ind];
    let total = 0;
    for (let i = 1; i <= score; i++)
        total += (i ** 2 + i) * scaling ** i;

    total = Math.round((1000000 * total * (0.05 / scaling)) * 100) / 100;
    return total;
};

const getActualXP = score =>
    ((score ** 3 / 6) + (score ** 2 / 2) + (score / 3)) * 100000;

const getSlayerValue = (xp, i) => {
    const score = Math.floor(getSlayerScore(xp));
    const effectiveXP = getEffectiveXP(score, i);
    const actualXP = getActualXP(score);
    const distance = xp - actualXP;
    const effectiveDistance = distance * slayerDeprecationScaling[i] ** score;
    return effectiveXP + effectiveDistance;
};

const getSlayerWeight = slayerXP => {
    const zombie = getSlayerValue(slayerXP[0], 0);
    const spider = getSlayerValue(slayerXP[1], 1);
    const wolf = getSlayerValue(slayerXP[2], 2);
    const enderman = getSlayerValue(slayerXP[3], 3);
    const blaze = getSlayerValue(slayerXP[4], 4)

    const individual = zombie / 8390.64 + spider / 7019.57 + wolf / 2982.06 + enderman / 1118.81 + blaze / 751.281;
    const extra = (slayerXP[0] + 1.6 * slayerXP[1] + 3.6 * slayerXP[2] + 10 * slayerXP[3] + 15 * slayerXP[4]) / 1000000;
    return 2 * (individual + extra);
};

const effectiveXP = (xp, factor) => {
    if (xp < skillMaxXP)
        return xp;
    else {
        let remainingXP = xp;
        let z = 0;
        for (let i = 0; i <= Math.trunc(xp / skillMaxXP); i++) {
            if (remainingXP >= skillMaxXP) {
                remainingXP -= skillMaxXP;
                z += factor ** i;
            }
        }
        return (z * skillMaxXP);
    }
};

const getSkillWeight = (skillLevels, skillXP) => {
    let skillAvg = 0;
    skillLevels.forEach(level => skillAvg += level);
    skillAvg /= skillLevels.length;

    const n = 12 * ((skillAvg / 60) ** 2.44780217148309);
    const r2 = 2 ** (1 / 2);

    let temp = [];
    for (let i = 0; i < skillLevels.length; i++) {
        temp.push(
            n * srw[Object.keys(srw)[i]][skillLevels[i]] * srw[Object.keys(srw)[i]][Object.keys(srw[Object.keys(srw)[i]]).length - 1] +
            srw[Object.keys(srw)[i]][Object.keys(srw[Object.keys(srw)[i]]).length - 1] * (skillLevels[i] / 60) ** r2
        );
    }

    let skillRating = 0;
    temp.forEach(thingy => {
        skillRating += thingy;
    });
    skillRating *= skillOverall;

    let overflowRating = 0;
    for (let i = 0; i < skillXP.length; i++) {
        if (skillXP[i] > skillMaxXP) {
            const factor = skillFactors[i];
            const effectiveOver = effectiveXP(skillXP[i] - skillMaxXP, factor);
            const rating = effectiveOver / skillMaxXP;
            const overflowMult = skillOverflowMultipliers[i];
            const t = rating * overflowMult;
            if (t > 0)
                overflowRating += 2 * (rating * overflowMult);
        }
    }

    return [skillRating, overflowRating];
};

const getDungeonExpWeight = cataXP => {
    let level = -1;
    for (let i = 0; i < dungeonExperienceTable.length; i++) {
        if (cataXP >= dungeonExperienceTable[i]) level++;
        else break;
    }

    if (level !== 50) {
        const nextLvlXP = dungeonExperienceTable[level + 1] - dungeonExperienceTable[level];
        const progress = Math.floor((cataXP - dungeonExperienceTable[level]) / nextLvlXP * 1000) / 1000;
        level += progress;
    }

    let n;
    let extra;
    if (cataXP < dungeonMaxXP)
        n = 0.2 * (level / 50) ** 1.538679118869934;
    else {
        let part = 142452410;
        extra = (500 * ((cataXP - dungeonMaxXP) / part) ** (1/1.781925776625157));
    }

    if (level !== 0) {
        if (cataXP < dungeonMaxXP) {
            return dungeonOverall * ((1.18340401286164044 ** (level + 1) - 1.05994990217254) * (1 + n));
        } else {
            return (4100 + extra) * 2;
        }
    } else {
        return 0;
    }
};

let max1000 = 0;
let mMax1000 = 0;
for (let i = 0; i < dungeonCompletionWorth.length; i++) {
    if (i < 8) max1000 += dungeonCompletionWorth[i];
    else mMax1000 += dungeonCompletionWorth[i];
}

max1000 *= 1000;
mMax1000 *= 1000;

const getLevelFromXP = xp => {
    let xpAdded = 0;
    for (let i = 0; i < 61; i++) {
        xpAdded += skillXPPerLevel[i];
        if (xp < xpAdded)
            return Math.floor((i - 1) + (xp - (xpAdded - skillXPPerLevel[i])) / skillXPPerLevel[i]);
    }

    return 60;
};

const getDungeonCompletionWeight = (cataCompl, mCataCompl) => {
    let upperBound = 1500;
    let score = 0;

    Object.entries(cataCompl).forEach(([floor, amount]) => {
        let excess = 0;
        if (amount > 1000) {
            excess = amount - 1000;
            amount = 1000;
        }

        let floorScore = amount * dungeonCompletionWorth[floor];
        if (excess > 0)
            floorScore *= Math.log(excess / 1000 + 1) / Math.log(7.5) + 1;
        score += floorScore;
    });

    const rating = score / max1000 * upperBound * 2;

    Object.entries(mCataCompl).forEach(([floor, amount]) => {
        if (Object.keys(dungeonCompletionBuffs).includes(floor)) {
            const threshold = 20;
            if (amount >= threshold) upperBound += dungeonCompletionBuffs[floor];
            else upperBound += dungeonCompletionBuffs[floor] * (amount / threshold) ** 1.840896416;
        }
    });

    let masterScore = 0;
    Object.entries(mCataCompl).forEach(([floor, amount]) => {
        let excess = 0;
        if (amount > 1000) {
            excess = amount - 1000;
            amount = 1000;
        }

        let floorScore = amount * dungeonCompletionWorth[7 + Number(floor)];
        if (excess > 0)
            floorScore *= (Math.log((excess / 1000) + 1) / Math.log(6)) + 1;
        masterScore += floorScore;
    });

    const masterRating = (masterScore / mMax1000) * upperBound * 2;
    return [rating, masterRating];
};

const getPlayer = async (uuid, apiKey) =>
    (await fetchJSON(`https://api.hypixel.net/player?key=${apiKey}&uuid=${uuid}`)).player;

async function getWeightRaw(skillLevels, skillXP, cataCompl, mCataCompl, cataXP, slayerXP) {
    const [skillWeight, overflowWeight] = getSkillWeight(skillLevels, skillXP);
    const [cataComplWeight, masterCataComplWeight] = getDungeonCompletionWeight(cataCompl, mCataCompl);
    const cataExpWeight = getDungeonExpWeight(cataXP);
    const slayerWeight = getSlayerWeight(slayerXP);

    return {
        total: (skillWeight + overflowWeight + cataComplWeight + masterCataComplWeight + cataExpWeight + slayerWeight),
        skill: {
            base: skillWeight,
            overflow: overflowWeight
        },
        catacombs: {
            completion: {
                base: cataComplWeight,
                master: masterCataComplWeight
            },
            experience: cataExpWeight
        },
        slayer: slayerWeight
    };
}
async function calculateLilyWeight(profile, uuid) {
    if (uuid.length === 36)
        uuid = uuid.replace(/-/g, "");

    const slayerXP = [
        profile.slayer_bosses?.zombie?.xp ?? 0,
        profile.slayer_bosses?.spider?.xp ?? 0,
        profile.slayer_bosses?.wolf?.xp ?? 0,
        profile.slayer_bosses?.enderman?.xp ?? 0,
        profile.slayer_bosses?.blaze?.xp ?? 0
    ];

    const cataCompl = profile.dungeons?.dungeon_types?.catacombs?.tier_completions ?? {};
    const mCataCompl = profile.dungeons?.dungeon_types?.master_catacombs?.tier_completions ?? {};
    const cataXP = profile.dungeons?.dungeon_types?.catacombs?.experience ?? 0;

    let skillLevels;
    let skillXP;
    if (!profile.experience_skill_mining) {
        // skill API is off
        const player = await getPlayer(uuid, process.env.HYPIXEL_API_KEY);
        const { achievements } = player;
        username = player.displayName;

        skillLevels = Object.values(skillNames).map(i => achievements?.[i] ?? 0);
        skillXP = skillLevels.map(getXpFromLevel);
    } else {
        skillXP = Object.keys(skillNames).map(i => profile[i]);
        skillLevels = skillXP.map(getLevelFromXP);
    }

    const weight = getWeightRaw(skillLevels, skillXP, cataCompl, mCataCompl, cataXP, slayerXP);
    return weight;
}

module.exports = { calculateLilyWeight }